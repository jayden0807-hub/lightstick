<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multech Virtual Lightstick — Audience</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; background:#000; overflow:hidden; }
    #stage { position:relative; width:100%; height:100%; }
    .bg { position:absolute; inset:0; background: radial-gradient(circle at 50% 40%, rgba(255,255,255,0.02), rgba(0,0,0,0.6)); z-index:0; pointer-events:none; }
    .heart {
      position:absolute;
      width: 120px; height: 120px;
      transform-origin:center center;
      opacity:0;
      pointer-events:none;
      will-change: transform, opacity, filter;
      z-index:10;
      filter: drop-shadow(0 0 18px rgba(255,100,160,0.45));
    }
    .particle {
      position:absolute;
      width:8px; height:8px;
      border-radius:50%;
      pointer-events:none;
      opacity:0.95;
      will-change: transform, opacity;
      z-index:9;
      mix-blend-mode: screen;
    }
  </style>
</head>
<body>
  <div id="stage"><div class="bg"></div></div>

  <script type="module">
    // ---------- Firebase 初始化 ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDkvbK-ubU4NKdUXGcj1vKgMNTsb7X2BTg",
      authDomain: "multech-lightshow.firebaseapp.com",
      databaseURL: "https://multech-lightshow-default-rtdb.firebaseio.com",
      projectId: "multech-lightshow",
      storageBucket: "multech-lightshow.firebasestorage.app",
      messagingSenderId: "237208759699",
      appId: "1:237208759699:web:dab1eb9f877811e687cc66",
      measurementId: "G-0YF1GWCWRV"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    console.log("Audience connected to DB:", firebaseConfig.databaseURL);
    // -------------------------------------

    const stage = document.getElementById('stage');
    const actionRef = ref(db, 'light/action');

    onValue(actionRef, (snap) => {
      const action = snap.val();
      if (!action) return;
      if (action.type === 'heart') spawnHeart(action);
      if (action.type === 'color') document.body.style.background = action.color;
    });

    function spawnHeart(params = {}) {
      const {
        color = '#ff77aa',
        duration = 1500,
        scaleFrom = 0.2,
        scaleTo = 1.6,
        x = null,
        y = null,
        size = 120
      } = params;

      const vw = window.innerWidth, vh = window.innerHeight;
      const posX = (x === null) ? (Math.random() * 0.8 + 0.1) * vw : x * vw;
      const posY = (y === null) ? (Math.random() * 0.6 + 0.2) * vh : y * vh;

      const heart = document.createElementNS("http://www.w3.org/2000/svg","svg");
      heart.setAttribute('viewBox','0 0 32 29');
      heart.classList.add('heart');
      heart.style.width = size + 'px';
      heart.style.height = size + 'px';
      heart.style.left = (posX - size/2) + 'px';
      heart.style.top = (posY - size/2) + 'px';

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute('d','M23.6,0C20.6,0,18,1.9,16,4.4C14,1.9,11.4,0,8.4,0C3.7,0,0,3.6,0,8.3c0,9.2,16,20.7,16,20.7S32,17.6,32,8.3 C32,3.6,28.3,0,23.6,0z');
      path.setAttribute('fill', color);
      heart.appendChild(path);

      heart.style.transform = `scale(${scaleFrom})`;
      heart.style.opacity = '0';
      heart.style.filter = `drop-shadow(0 0 12px ${color})`;

      stage.appendChild(heart);
      void heart.offsetWidth;
      heart.style.transition = `transform ${duration/1000}s cubic-bezier(.2,.9,.3,1), opacity ${duration/1000}s linear`;
      requestAnimationFrame(() => {
        heart.style.transform = `scale(${scaleTo})`;
        heart.style.opacity = '0.95';
      });

      createParticles({x: posX, y: posY, color, count: 10, spread: 140});
      setTimeout(() => { heart.style.opacity = '0'; setTimeout(() => heart.remove(), 400); }, duration);
    }

    function createParticles({x, y, color='#ff9abf', count=10, spread=120}) {
      for (let i=0;i<count;i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = (x - 4) + 'px';
        p.style.top = (y - 4) + 'px';
        p.style.width = p.style.height = (Math.random()*8 + 4) + 'px';
        p.style.background = color;
        stage.appendChild(p);
        const angle = Math.random() * Math.PI * 2;
        const dist = Math.random() * spread;
        const tx = Math.cos(angle) * dist;
        const ty = Math.sin(angle) * dist - Math.random()*20;
        const dur = 800 + Math.random()*800;
        p.style.transition = `transform ${dur/1000}s cubic-bezier(.08,.9,.4,1), opacity ${dur/1000}s linear`;
        requestAnimationFrame(() => {
          p.style.transform = `translate(${tx}px, ${ty}px) scale(${0.3 + Math.random()*1.2})`;
          p.style.opacity = 0;
        });
        setTimeout(() => p.remove(), dur + 60);
      }
    }

    window.addEventListener('keydown', (e) => {
      if (e.key === 'h') spawnHeart({ color:'#ff99c8', duration:1200, scaleFrom:0.2, scaleTo:1.8 });
    });
  </script>
</body>
</html>
