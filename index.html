<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multech Virtual Lightstick — Audience</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; background:#000; overflow:hidden; }
    #stage { position:relative; width:100%; height:100%; }
    .bg { position:absolute; inset:0; background: radial-gradient(circle at 50% 40%, rgba(255,255,255,0.02), rgba(0,0,0,0.6)); z-index:0; pointer-events:none; }

    .heart {
      position:absolute;
      width: 120px; height: 120px;
      transform-origin:center center;
      opacity:0;
      pointer-events:none;
      will-change: transform, opacity, filter;
      z-index:10;
      filter: drop-shadow(0 0 18px rgba(255,100,160,0.45));
    }

    .particle {
      position:absolute;
      width:8px; height:8px;
      border-radius:50%;
      pointer-events:none;
      opacity:0.95;
      will-change: transform, opacity;
      z-index:9;
      mix-blend-mode: screen;
    }
  </style>
</head>
<body>
  <div id="stage"><div class="bg"></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    // ---------- 把以下 firebaseConfig 替换为你的项目信息 ----------
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
    };
    // ----------------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const stage = document.getElementById('stage');

    // 默认订阅节点（若做分区，请改为 light/areaA/action 等）
    const actionRef = ref(db, 'light/action');

    onValue(actionRef, (snap) => {
      const action = snap.val();
      if (!action) return;
      // type: heart / color / etc
      if (action.type === 'heart') spawnHeart(action);
      if (action.type === 'color') applyBackgroundColor(action);
    });

    // 把全屏背景色也支持（如果需要）
    function applyBackgroundColor(action) {
      const color = action.color || '#000';
      document.body.style.background = color;
    }

    // 生成心 + 粒子效果
    function spawnHeart(params = {}) {
      const {
        color = '#ff77aa',
        duration = 1500,
        scaleFrom = 0.2,
        scaleTo = 1.6,
        x = null,
        y = null,
        size = 120
      } = params;

      const vw = window.innerWidth, vh = window.innerHeight;
      const posX = (x === null) ? (Math.random() * 0.8 + 0.1) * vw : x * vw;
      const posY = (y === null) ? (Math.random() * 0.6 + 0.2) * vh : y * vh;

      // SVG 心形
      const heart = document.createElementNS("http://www.w3.org/2000/svg","svg");
      heart.setAttribute('viewBox','0 0 32 29');
      heart.classList.add('heart');
      heart.style.width = size + 'px';
      heart.style.height = size + 'px';
      heart.style.left = (posX - size/2) + 'px';
      heart.style.top = (posY - size/2) + 'px';

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute('d','M23.6,0C20.6,0,18,1.9,16,4.4C14,1.9,11.4,0,8.4,0C3.7,0,0,3.6,0,8.3c0,9.2,16,20.7,16,20.7S32,17.6,32,8.3 C32,3.6,28.3,0,23.6,0z');
      path.setAttribute('fill', color);
      heart.appendChild(path);

      // initial state
      heart.style.transform = `scale(${scaleFrom}) translateZ(0)`;
      heart.style.opacity = '0';
      heart.style.filter = `drop-shadow(0 0 12px ${color})`;

      stage.appendChild(heart);
      void heart.offsetWidth; // 强制重排

      // 动画
      heart.style.transition = `transform ${duration/1000}s cubic-bezier(.2,.9,.3,1), opacity ${duration/1000}s linear`;
      requestAnimationFrame(() => {
        heart.style.transform = `scale(${scaleTo}) translateZ(0)`;
        heart.style.opacity = '0.95';
      });

      // 粒子爆发
      createParticles({x: posX, y: posY, color, count: 12, spread: Math.min(140, size*1.6)});

      // 结束后 fade out & remove
      setTimeout(() => {
        heart.style.opacity = '0';
        setTimeout(() => { if (heart.parentNode) heart.parentNode.removeChild(heart); }, 350);
      }, duration);

      return heart;
    }

    // 粒子函数
    function createParticles({x, y, color='#ff9abf', count=10, spread=120}) {
      for (let i=0;i<count;i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = (x - 4) + 'px';
        p.style.top = (y - 4) + 'px';
        p.style.width = (Math.random()*8 + 4) + 'px';
        p.style.height = p.style.width;
        p.style.background = color;
        p.style.opacity = 0.95;
        stage.appendChild(p);

        const angle = Math.random() * Math.PI * 2;
        const dist = Math.random() * spread;
        const tx = Math.cos(angle) * dist;
        const ty = Math.sin(angle) * dist - Math.random()*20;

        // duration & easing
        const dur = 800 + Math.random()*800;
        p.style.transition = `transform ${dur/1000}s cubic-bezier(.08,.9,.4,1), opacity ${dur/1000}s linear`;
        requestAnimationFrame(() => {
          p.style.transform = `translate(${tx}px, ${ty}px) scale(${0.3 + Math.random()*1.2})`;
          p.style.opacity = 0;
        });

        setTimeout(() => { if (p.parentNode) p.parentNode.removeChild(p); }, dur + 60);
      }
    }

    // local debug: 按键 H 试心，空格发 burst
    window.addEventListener('keydown', (e) => {
      if (e.key === 'h') spawnHeart({ color:'#ff99c8', duration:1200, scaleFrom:0.2, scaleTo:1.8 });
      if (e.code === 'Space') {
        for (let i=0;i<5;i++) setTimeout(()=> spawnHeart({ color:'#ff77aa', duration:1200, scaleFrom:0.2, scaleTo:1.6 }), i*120);
      }
    });
  </script>
</body>
</html>
