<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multech Lightstick â€” Audience (final)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#000}
    html,body{height:100%;margin:0;background:var(--bg);overflow:hidden;font-family:Inter,system-ui,Arial}
    #stage{position:relative;width:100%;height:100%;touch-action:none}
    #bg{position:absolute;inset:0;z-index:0;background:#000;transition:background 300ms linear}
    .effect-el{position:absolute;pointer-events:none;will-change:transform,opacity;mix-blend-mode:screen}
    /* bubble / heart / star base (no circular bg) */
    .bubble, .heart-el, .star-el {
      position:absolute;
      z-index:12;
      overflow:visible;
      mix-blend-mode:screen;
      pointer-events:none;
      display:block;
    }
    /* highlight for bubbles only (we keep bubble shine) */
    .bubble::after {
      content:"";
      position:absolute;left:0;top:0;right:0;bottom:0;border-radius:50%;
      background: radial-gradient(circle at 28% 28%, rgba(255,255,255,0.92), rgba(255,255,255,0.14) 20%, rgba(255,255,255,0) 55%);
      pointer-events:none; mix-blend-mode:overlay; opacity:0.5;
    }
    /* marquee centered vertically */
    .marquee-wrap{position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);z-index:30;pointer-events:none;display:flex;justify-content:center;align-items:center;overflow:hidden}
    .marquee{white-space:nowrap;font-weight:800;display:inline-block}
    @media (max-width:520px){ .marquee{font-size:18px} }
  </style>
</head>
<body>
  <div id="stage"><div id="bg"></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // Firebase config (your project)
    const firebaseConfig = {
      apiKey: "AIzaSyDkvbK-ubU4NKdUXGcj1vKgMNTsb7X2BTg",
      authDomain: "multech-lightshow.firebaseapp.com",
      databaseURL: "https://multech-lightshow-default-rtdb.firebaseio.com",
      projectId: "multech-lightshow",
      storageBucket: "multech-lightshow.firebasestorage.app",
      messagingSenderId: "237208759699",
      appId: "1:237208759699:web:dab1eb9f877811e687cc66",
      measurementId: "G-0YF1GWCWRV"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    console.log('Audience DB connected:', firebaseConfig.databaseURL);

    const stage = document.getElementById('stage');
    const bg = document.getElementById('bg');

    let blinkTimer = null, blink2Timer = null, marqueeTimer = null;

    // Listen DB actions
    const actionRef = ref(db, 'light/action');
    onValue(actionRef, snap => {
      const action = snap.val();
      if (!action) return;
      console.log('ACTION recv:', action);
      handleAction(action);
    });

    function handleAction(a){
      const t = a.type;
      switch(t){
        case 'steady': applySteady(a); break;
        case 'blink': applyBlink(a); break;
        case 'blink2': applyBlink2(a); break;
        case 'bubble': spawnManyBubbles(Math.max(1,a.count||20), a.color||'#9ae0ff', a.spread||0); break;
        case 'heart': spawnManyHearts(Math.max(1,a.count||1), a.color||'#ff77aa', a.size||80); break;
        case 'heart_blast': spawnManyHearts(Math.max(5,a.count||24), a.color||'#ff77aa'); break;
        case 'star': spawnManyStars(Math.max(1,a.count||1), a.color||'#fff1a8', a.size||80); break;
        case 'star_blast': spawnManyStars(Math.max(4,a.count||18), a.color||'#fff1a8'); break;
        case 'marquee': spawnMarquee(a.text||'', a.color||'#fff', Math.max(500,a.speed||12000), Math.max(12,a.fontSize||28)); break;
        case 'clear_effect': clearEffect(a.effect); break;
        case 'clear': clearAll(); break;
        default: console.warn('unknown action', t);
      }
    }

    /* ---------- effects ---------- */

    function applySteady(a){
      bg.style.background = a.color || '#ff77aa';
    }

    function applyBlink(a){
      if (blinkTimer) clearInterval(blinkTimer);
      if (blink2Timer){ clearInterval(blink2Timer); blink2Timer=null; }
      const color = a.color || '#ff77aa';
      const speed = Math.max(60, a.speed || 400);
      let on=false;
      blinkTimer = setInterval(()=> { bg.style.background = on ? color : '#000'; on=!on; }, speed);
    }

    function applyBlink2(a){
      if (blinkTimer){ clearInterval(blinkTimer); blinkTimer=null; }
      if (blink2Timer) clearInterval(blink2Timer);
      const A = a.colorA || '#ff77aa';
      const B = a.colorB || '#0077ff';
      const speed = Math.max(60, a.speed || 400);
      let state = 0;
      blink2Timer = setInterval(()=> { bg.style.background = (state % 2 === 0) ? A : B; state++; }, speed);
    }

    /* Bubble (kept) */
    function spawnManyBubbles(n, color, spread){
      for (let i=0;i<n;i++) setTimeout(()=> spawnBubble({ color, spread }), i*40);
    }
    function spawnBubble({ color='#9ae0ff', spread=0 }){
      const vw = innerWidth, vh = innerHeight;
      const el = document.createElement('div'); el.className = 'bubble effect-el';
      const size = 24 + Math.random()*96;
      el.style.width = el.style.height = size + 'px';
      const startY = (Math.random()*1.6 - 0.3) * vh;
      el.style.left = (Math.random()*vw - size/2) + 'px';
      el.style.top = startY + 'px';
      el.style.background = color;
      el.style.opacity = (0.2 + Math.random()*0.7).toString();
      stage.appendChild(el);
      const endY = - (50 + Math.random()*300);
      const tx = (spread>0) ? (Math.random()*spread - spread/2) : (Math.random()*280 - 140);
      const lifeMs = 12000 + Math.random()*14000;
      el.style.transition = `transform ${lifeMs/1000}s linear, opacity ${lifeMs/1000}s linear`;
      requestAnimationFrame(()=> {
        el.style.transform = `translate(${tx}px, ${endY - startY}px) scale(${0.6 + Math.random()*0.8})`;
        el.style.opacity = '0.05';
      });
      setTimeout(()=> { if (el.parentNode) el.remove(); }, lifeMs + 300);
    }

    /* Heart (SVG only, no circle bg) */
    function spawnManyHearts(n, color, size){
      for (let i=0;i<n;i++) setTimeout(()=> spawnHeart({ color, size: (size||40) + Math.random()*80 }), i*50);
    }
    function spawnHeart({ color='#ff77aa', size=80 }){
      const vw = innerWidth, vh = innerHeight;
      const el = document.createElement('div'); el.className = 'heart-el effect-el';
      el.style.width = el.style.height = size + 'px';
      const startY = (Math.random()*1.6 - 0.3) * vh;
      el.style.left = (Math.random()*vw - size/2) + 'px';
      el.style.top = startY + 'px';
      el.style.background = 'transparent';
      el.style.opacity = '0.95';
      // inline heart svg
      const ns = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(ns,'svg'); svg.setAttribute('viewBox','0 0 32 29');
      svg.style.width='100%'; svg.style.height='100%'; svg.style.display='block';
      const path = document.createElementNS(ns,'path');
      path.setAttribute('d','M23.6,0C20.6,0,18,1.9,16,4.4C14,1.9,11.4,0,8.4,0C3.7,0,0,3.6,0,8.3c0,9.2,16,20.7,16,20.7S32,17.6,32,8.3 C32,3.6,28.3,0,23.6,0z');
      path.setAttribute('fill', color);
      svg.appendChild(path); el.appendChild(svg);
      stage.appendChild(el);
      const endY = - (50 + Math.random()*300);
      const tx = (Math.random()*280 - 140);
      const lifeMs = 12000 + Math.random()*14000;
      el.style.transition = `transform ${lifeMs/1000}s linear, opacity ${lifeMs/1000}s linear`;
      requestAnimationFrame(()=> {
        el.style.transform = `translate(${tx}px, ${endY - startY}px) scale(${0.6 + Math.random()*0.8})`;
        el.style.opacity = '0.05';
      });
      setTimeout(()=> { if (el.parentNode) el.remove(); }, lifeMs + 300);
    }

    /* Star (SVG only, no circle bg) */
    function spawnManyStars(n, color, size){
      for (let i=0;i<n;i++) setTimeout(()=> spawnStar({ color, size: (size||40) + Math.random()*80 }), i*60);
    }
    function spawnStar({ color='#fff1a8', size=80 }){
      const vw = innerWidth, vh = innerHeight;
      const el = document.createElement('div'); el.className='star-el effect-el';
      el.style.width = el.style.height = size + 'px';
      const startY = (Math.random()*1.6 - 0.3) * vh;
      el.style.left = (Math.random()*vw - size/2) + 'px';
      el.style.top = startY + 'px';
      el.style.background = 'transparent';
      el.style.opacity = '0.95';
      const ns = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(ns,'svg'); svg.setAttribute('viewBox','0 0 64 64');
      svg.style.width='100%'; svg.style.height='100%'; svg.style.display='block';
      const p = document.createElementNS(ns,'path');
      p.setAttribute('d','M32 4 L39 24 L60 24 L42 36 L49 56 L32 44 L15 56 L22 36 L4 24 L25 24 Z');
      p.setAttribute('fill', color);
      svg.appendChild(p); el.appendChild(svg);
      stage.appendChild(el);
      const endY = - (50 + Math.random()*300);
      const tx = (Math.random()*280 - 140);
      const lifeMs = 12000 + Math.random()*14000;
      el.style.transition = `transform ${lifeMs/1000}s linear, opacity ${lifeMs/1000}s linear`;
      requestAnimationFrame(()=> {
        el.style.transform = `translate(${tx}px, ${endY - startY}px) scale(${0.6 + Math.random()*0.8})`;
        el.style.opacity = '0.05';
      });
      setTimeout(()=> { if (el.parentNode) el.remove(); }, lifeMs + 300);
    }

    /* Marquee: start offscreen right -> move left */
    function spawnMarquee(text, color, speedMs, fontSize){
      if (!text) return;
      // remove previous marquees
      document.querySelectorAll('.marquee-wrap').forEach(e=>e.remove());
      if (marqueeTimer){ clearTimeout(marqueeTimer); marqueeTimer = null; }

      const wrap = document.createElement('div'); wrap.className = 'marquee-wrap';
      wrap.style.position = 'absolute';
      wrap.style.left = '0';
      wrap.style.right = '0';
      wrap.style.top = '50%';
      wrap.style.transform = 'translateY(-50%)';
      wrap.style.overflow = 'hidden';
      wrap.style.pointerEvents = 'none';

      const span = document.createElement('div'); span.className = 'marquee';
      span.style.position = 'absolute';
      span.style.whiteSpace = 'nowrap';
      span.style.fontWeight = '800';
      span.style.fontSize = fontSize + 'px';
      span.style.color = color;
      span.textContent = text;

      wrap.appendChild(span); stage.appendChild(wrap);

      requestAnimationFrame(()=> {
        const extraPad = 120; // push start further right so it truly enters from off-screen
        const startX = window.innerWidth + extraPad;
        const endX = - span.offsetWidth - extraPad;
        span.style.transform = `translateX(${startX}px)`;
        requestAnimationFrame(()=> {
          span.style.transition = `transform ${speedMs/1000}s linear`;
          span.style.transform = `translateX(${endX}px)`;
        });
      });

      marqueeTimer = setTimeout(()=> { wrap.remove(); marqueeTimer=null; }, speedMs + 300);
    }

    /* clear helpers */
    function clearEffect(effect){
      if (effect === 'blink'){ if (blinkTimer){ clearInterval(blinkTimer); blinkTimer=null; } }
      if (effect === 'blink2'){ if (blink2Timer){ clearInterval(blink2Timer); blink2Timer=null; } }
      if (effect === 'bubble'){ document.querySelectorAll('.bubble').forEach(e=>e.remove()); }
      if (effect === 'heart'){ document.querySelectorAll('.heart-el').forEach(e=>e.remove()); }
      if (effect === 'star'){ document.querySelectorAll('.star-el').forEach(e=>e.remove()); }
      if (effect === 'marquee'){ document.querySelectorAll('.marquee-wrap').forEach(e=>e.remove()); if (marqueeTimer){ clearTimeout(marqueeTimer); marqueeTimer=null; } }
    }
    function clearAll(){
      if (blinkTimer){ clearInterval(blinkTimer); blinkTimer=null; }
      if (blink2Timer){ clearInterval(blink2Timer); blink2Timer=null; }
      document.querySelectorAll('.effect-el, .marquee-wrap').forEach(e=>e.remove());
      bg.style.background = '#000';
    }

    // debug handles
    window._multech = {
      spawnManyBubbles, spawnManyHearts, spawnManyStars, spawnMarquee, clearAll, clearEffect
    };
  </script>
</body>
</html>
