<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multech Virtual Lightstick — Audience (Full)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; background:#000; overflow:hidden; font-family: Inter, system-ui, Arial; -webkit-font-smoothing:antialiased; }
    #stage { position:relative; width:100%; height:100%; touch-action:none; }
    .bg { position:absolute; inset:0; z-index:0; pointer-events:none; background:#000; transition: background 300ms linear; }

    /* common */
    .effect-el { position:absolute; pointer-events:none; will-change: transform, opacity; }

    /* heart */
    .heart { width:120px; height:120px; z-index:12; transform-origin:center center; filter: drop-shadow(0 0 18px rgba(255,100,160,0.45)); }

    /* bubble */
    .bubble { border-radius:50%; z-index:9; mix-blend-mode: screen; opacity:0.95; }

    /* floating text (upwards) */
    .floating-text { position:absolute; left:50%; transform:translateX(-50%); font-weight:700; white-space:nowrap; z-index:11; pointer-events:none; }

    /* marquee (horizontal scrolling) */
    .marquee-wrap { position:absolute; left:0; right:0; bottom:14%; height:48px; display:flex; align-items:center; overflow:hidden; z-index:13; pointer-events:none; }
    .marquee { display:inline-block; white-space:nowrap; font-weight:700; text-shadow:0 0 10px rgba(0,0,0,0.5); }

    /* helper to remove everything quickly */
    .invisible { opacity:0 !important; transform:none !important; }

    /* small responsive */
    @media (max-width:520px) {
      .marquee-wrap { bottom:10%; height:36px; }
      .heart { width:92px; height:92px; }
    }
  </style>
</head>
<body>
  <div id="stage">
    <div id="bg" class="bg"></div>
  </div>

  <script type="module">
    // ---------- Firebase 初始化 ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDkvbK-ubU4NKdUXGcj1vKgMNTsb7X2BTg",
      authDomain: "multech-lightshow.firebaseapp.com",
      databaseURL: "https://multech-lightshow-default-rtdb.firebaseio.com",
      projectId: "multech-lightshow",
      storageBucket: "multech-lightshow.firebasestorage.app",
      messagingSenderId: "237208759699",
      appId: "1:237208759699:web:dab1eb9f877811e687cc66",
      measurementId: "G-0YF1GWCWRV"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    console.log("Audience connected to DB:", firebaseConfig.databaseURL);
    // -------------------------------------

    const stage = document.getElementById('stage');
    const bg = document.getElementById('bg');

    // keep track of ongoing intervals / timeouts
    let blinkInterval = null;
    let fadeTimeout = null;
    let marqueeTimeout = null;

    // Listen to actions
    const actionRef = ref(db, 'light/action');
    onValue(actionRef, (snap) => {
      const action = snap.val();
      if (!action) return;
      // Basic validation: require ts to avoid reprocessing same object? we still handle each event.
      handleAction(action);
    });

    function clearAllEffects() {
      if (blinkInterval) { clearInterval(blinkInterval); blinkInterval = null; }
      if (fadeTimeout) { clearTimeout(fadeTimeout); fadeTimeout = null; }
      if (marqueeTimeout) { clearTimeout(marqueeTimeout); marqueeTimeout = null; }
      // remove generated elements
      document.querySelectorAll('.bubble, .floating-text, .heart, .marquee-wrap').forEach(el => el.remove());
      // reset background to black if desired (we keep current bg unless steady set)
      // bg.style.background = '#000';
    }

    async function handleAction(action) {
      const t = action.type;
      if (!t) return;
      // Provide logging for debugging
      console.log('Received action:', action);
      if (t === 'clear') { clearAllEffects(); return; }

      // types: steady, blink (single), blink2 (two-color), fade, bubble, text, heart, marquee
      switch (t) {
        case 'steady':
          clearAllEffects();
          bg.style.transition = 'background 300ms linear';
          bg.style.background = action.color || '#ff77aa';
          break;

        case 'blink':
          clearAllEffects();
          startBlink(action.color || '#ff77aa', parseInt(action.speed || 400));
          break;

        case 'blink2':
          clearAllEffects();
          startBlinkTwoColor(action.colorA || '#ff77aa', action.colorB || '#0077ff', parseInt(action.speed || 400));
          break;

        case 'fade':
          clearAllEffects();
          startFade(action.color || '#ff77aa', parseInt(action.duration || 2000));
          break;

        case 'bubble':
          spawnBubbles({ color: action.color || '#9ae0ff', count: parseInt(action.count || 12), spread: parseInt(action.spread || 0) });
          break;

        case 'text':
          spawnText({ text: action.text || '', color: action.color || '#fff', duration: parseInt(action.duration || 3000), fontSize: parseInt(action.fontSize || 28) });
          break;

        case 'marquee':
          spawnMarquee({ text: action.text || '', color: action.color || '#fff', speed: parseInt(action.speed || 12000), fontSize: parseInt(action.fontSize || 28) });
          break;

        case 'heart':
          spawnHeart({ color: action.color || '#ff77aa', duration: parseInt(action.duration || 1500), scaleFrom: action.scaleFrom || 0.2, scaleTo: action.scaleTo || 1.6, size: action.size || 120, x: action.x, y: action.y });
          break;

        default:
          console.warn('Unknown action type:', t);
      }
    }

    /* ======= visual routines ======= */

    // Blink single color <-> black
    function startBlink(color='#ff77aa', speed=400) {
      let on = false;
      bg.style.background = '#000';
      blinkInterval = setInterval(() => {
        bg.style.background = on ? color : '#000';
        on = !on;
      }, speed);
    }

    // Blink two colors alternately
    function startBlinkTwoColor(colorA='#ff77aa', colorB='#0077ff', speed=400) {
      let state = 0;
      bg.style.background = '#000';
      blinkInterval = setInterval(() => {
        if (state === 0) { bg.style.background = colorA; state = 1; }
        else if (state === 1) { bg.style.background = colorB; state = 2; }
        else { bg.style.background = '#000'; state = 0; } // optional black gap; cycles A -> B -> black
      }, speed);
    }

    // Fade in/out (smooth opacity-based pulse)
    function startFade(color='#ff77aa', duration=2000) {
      // make a full-screen overlay div to animate opacity
      const overlay = document.createElement('div');
      overlay.style.position = 'absolute';
      overlay.style.inset = '0';
      overlay.style.background = color;
      overlay.style.opacity = '0';
      overlay.style.zIndex = 5;
      overlay.style.pointerEvents = 'none';
      overlay.style.transition = `opacity ${duration/1000}s ease-in-out`;
      stage.appendChild(overlay);
      // Trigger fade in then out
      requestAnimationFrame(() => { overlay.style.opacity = '0.95'; });
      fadeTimeout = setTimeout(() => {
        overlay.style.opacity = '0';
        setTimeout(()=> overlay.remove(), duration + 200);
      }, duration);
    }

    // Bubbles
    function spawnBubbles({ color='#9ae0ff', count=12, spread=0 }) {
      for (let i=0;i<count;i++){
        setTimeout(()=> spawnBubble({ color, spread }), i*80);
      }
    }

    function spawnBubble({ color='#9ae0ff', spread=0 }) {
      const vw = window.innerWidth, vh = window.innerHeight;
      const el = document.createElement('div');
      el.className = 'bubble effect-el';
      const size = 8 + Math.random()*24;
      el.style.width = el.style.height = size + 'px';
      const x = Math.random() * vw;
      const startY = vh + 20;
      el.style.left = (x - size/2) + 'px';
      el.style.top = startY + 'px';
      el.style.background = color;
      stage.appendChild(el);
      const endY = Math.random() * vh * 0.35;
      const tx = (spread>0) ? (Math.random()*spread - spread/2) : (Math.random()*160 - 80);
      const dur = 1600 + Math.random()*1800;
      el.style.transition = `transform ${dur/1000}s ease-out, opacity ${dur/1000}s linear`;
      requestAnimationFrame(()=> {
        el.style.transform = `translate(${tx}px, ${- (startY - endY)}px) scale(${0.4 + Math.random()*1.1})`;
        el.style.opacity = '0';
      });
      setTimeout(()=> el.remove(), dur + 80);
    }

    // Floating text (from bottom upward)
    function spawnText({ text='#', color='#fff', duration=3000, fontSize=28 }) {
      const el = document.createElement('div');
      el.className = 'floating-text effect-el';
      el.textContent = text;
      el.style.color = color;
      el.style.fontSize = fontSize + 'px';
      const vw = window.innerWidth, vh = window.innerHeight;
      const leftPct = 20 + Math.random()*60; // 20% ~ 80%
      el.style.left = leftPct + '%';
      const startY = vh + 40;
      el.style.top = startY + 'px';
      stage.appendChild(el);
      const moveUp = vh*0.6 + (Math.random()*60 - 30);
      el.style.transition = `transform ${duration/1000}s cubic-bezier(.2,.9,.3,1), opacity ${duration/1000}s linear`;
      requestAnimationFrame(()=> {
        el.style.transform = `translateY(-${moveUp}px)`;
        el.style.opacity = '0';
      });
      setTimeout(()=> el.remove(), duration + 200);
    }

    // Marquee (scrolling horizontal text across screen)
    function spawnMarquee({ text='Hello', color='#fff', speed=12000, fontSize=28 }) {
      // create wrapper at bottom
      const wrap = document.createElement('div');
      wrap.className = 'marquee-wrap';
      wrap.style.bottom = (window.innerHeight * 0.08) + 'px';
      wrap.style.zIndex = 13;
      const span = document.createElement('div');
      span.className = 'marquee';
      span.textContent = text + '   •   ' + text; // repeat for continuous feel
      span.style.color = color;
      span.style.fontSize = fontSize + 'px';
      wrap.appendChild(span);
      stage.appendChild(wrap);

      // measure width and animate
      requestAnimationFrame(()=> {
        const fullW = span.offsetWidth;
        span.style.transform = `translateX(${window.innerWidth}px)`;
        span.style.transition = `transform ${speed/1000}s linear`;
        requestAnimationFrame(()=> {
          // move left by fullW + screen width
          span.style.transform = `translateX(-${fullW}px)`;
        });
      });
      // remove after animation
      marqueeTimeout = setTimeout(()=> {
        wrap.remove();
      }, speed + 300);
    }

    // Heart (kept as original)
    function spawnHeart(params={}) {
      const { color='#ff77aa', duration=1500, scaleFrom=0.2, scaleTo=1.6, x=null, y=null, size=120 } = params;
      const vw = window.innerWidth, vh = window.innerHeight;
      const posX = (x === null) ? (Math.random()*0.8 + 0.1)*vw : x*vw;
      const posY = (y === null) ? (Math.random()*0.6 + 0.2)*vh : y*vh;
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('viewBox','0 0 32 29');
      svg.className = 'heart effect-el';
      svg.style.width = size + 'px';
      svg.style.height = size + 'px';
      svg.style.left = (posX - size/2) + 'px';
      svg.style.top = (posY - size/2) + 'px';
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d','M23.6,0C20.6,0,18,1.9,16,4.4C14,1.9,11.4,0,8.4,0C3.7,0,0,3.6,0,8.3c0,9.2,16,20.7,16,20.7S32,17.6,32,8.3 C32,3.6,28.3,0,23.6,0z');
      path.setAttribute('fill', color);
      svg.appendChild(path);
      stage.appendChild(svg);
      svg.style.transform = `scale(${scaleFrom})`;
      svg.style.opacity = '0';
      svg.style.transition = `transform ${duration/1000}s cubic-bezier(.2,.9,.3,1), opacity ${duration/1000}s linear`;
      requestAnimationFrame(()=> {
        svg.style.transform = `scale(${scaleTo})`;
        svg.style.opacity = '0.95';
      });
      setTimeout(()=> { svg.style.opacity = '0'; setTimeout(()=> svg.remove(), 400); }, duration);
    }

    // debug: expose some functions to console
    window._multech_debug = { spawnBubble, spawnText, spawnHeart, spawnMarquee, startBlink, startBlinkTwoColor, startFade, clearAllEffects };
  </script>
</body>
</html>
